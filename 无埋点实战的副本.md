# 途家无埋点实现之路 - 实战

## 背景
目前移动互联网行业都是依附了着大数据平台来分析用户行为来做出更适用用于用户的产品，那么客户端就需要提供精准的数据采样的机制.

公司原有的埋点是采用手动代码埋点方案，使用起来虽然灵活，但由于开发成本较高（每次新的需求都意味着迎来不同的埋点需求）。随之我们开启了对无痕埋点的探索和实践，目标能将App可能发生的采样点做到通过一整套框架来Hook，达到真正的AOP来大大降低开发人员的开发成本.

## 为什么要实现无埋点
#### 从前的手动埋点流程分为几个步骤：
* PM列出所需要的数据点 (ps: 列出本期需求所需要看的数据点。如：某个按钮的点击量、统计热区是哪？)
* BI部门归纳产品需求采样列表.
* 开发基于BI部门列出的数据采样点，做每个采样点做对应的开发.

> 需要在每个采样点去编写类似的代码

```
UserActionModel action = new UserActionModel
        .UserActionBuilder()
        .buildRefInfoWithBaseActivity(activity)
        .buildActItemText("电话")
        .buildActPage(act_page)
        .buildActItemOtherInfo(String.valueOf(id))
        .buildActPos("6")
        .build();
TJUserActionLogAgent.addUserAction(action);
```

![流程1](https://github.com/dengluoy/PicassoUtils/blob/master/flow4.jpg?raw=true)

#### 实现无痕埋点之后的步骤:
* PM列出本期需求所想看的数据 (ps: 列出本期需求所需要看的数据点。如：某个按钮的点击量、统计热区是哪？)
* BI基于PM需求，列出对应的数据点。
* RD基于BI给的需求只需要对每个页面添加一行代码。

> 只需要在页面中添加一行识别代码

```
TAVOpenApi.setPageName(this, String.valueOf("xxxxId_" + houseId));
```

![流程12](https://github.com/dengluoy/PicassoUtils/blob/master/flow5.jpg?raw=true)

> ***可以看到。无痕埋点在每次需求开发时，大大减少了开发时间、开发风险***

## 无埋点技术技术架构
### 1. Gradle Plugin开发，实现AOP注入
### 2. 提供数据采用工具类开发，主要处理对应数据格式上报

> SDK架构图

![架构1](https://github.com/dengluoy/PicassoUtils/blob/master/framework2.jpg?raw=true)

### Gradle Plugin开发关键技术点

#### Hook Click事件、Dialog弹窗事件等
1. 采用Transform API 拦截.class转变.dex生命周期
2. 采用ASM做字节码注入。

***Transform工作流程***
> Gradle Transform API 是Gradle1.5.0-beta1 引入的。可以用于在Android打包过程中设置Hook点

![](https://upload-images.jianshu.io/upload_images/2965551-f289ae9bb2767f59?imageMogr2/auto-orient/strip%7CimageView2/2/w/980/format/webp)



既然我们想用字节码注入的方式来实现无埋点，那么我们需要对整体的Android打包机制有一定的了解。咱们先来看下Android的整体的构建流程.

![](https://user-gold-cdn.xitu.io/2018/3/8/16204d3ceedb2328?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

Android使用Gradle打包的本质其实是将上图的基本每个节点拆解成一个一个单独Task来完成。如: aapt、JavaCompiler、apkBuilder等等.
那么根据我们的需求其实可以发现。其中JavaCompiler之后的这个时间节点是完全可以满足我们的需求的。

![](https://github.com/dengluoy/PicassoUtils/blob/master/class.jpg?raw=true)

#### ASM注入流程
我们在生成.class文件后，拦截掉对应需要注入的Class文件。随后扫描该类的Method列表。找到对应的代码块注入数据采样代码
> 具体流程如下:

![](https://github.com/dengluoy/PicassoUtils/blob/master/flow3.jpg?raw=true)


### 数据采样SDK核心代码实现
> 分为以下几个模块

#### 1. 构建View唯一标识
#### 2. 页面划分 -区分Fragment页面
#### 3. Dialog弹窗代理类实现 (在代理类中实现数据采样)
#### 4. 统计PV、UV等数据

#### 构建View唯一标识
1.1. 利用TargetView向上遍历ViewTree找到根节点，同时过滤掉DecorView已达到最小、唯一的ViewPath路径。来确定点击id

1.2. 同时根据采集过来的Fragment集合中寻找对应的FragmentRootView，添加Fragment节点
最后的数据展示

```
ContentView/FrameLayout[0]/LinearLayout[0]/ViewPager[0]/FragmentA[0]/AppCompatButton[0]
```

#### 页面划分

2.1. 基于Fragment的onResume、onPause、onHiddenChanged、setUserVisibleHint四个生命周期的数据采样

2.2. 维护一个Fragment集合。在每次的点击中。根据FragmentRootView节点判断，当前点击发生的页面名称

#### Dialog弹窗代理类实现

3.1. 复写Dialog的show方法（加入采样代码)

3.2. 复写AlertDialog的show方法（加入采样代码)

3.3. 复写AlertDialogBuilder的create方法（加入采样代码)

3.4. 复写AlertDialogFragment的onCreateView方法（加入采样代码)

#### 统计PV、UV、前后台切换
4.1. 添加ActivityLifecycleCallabck类。

4.2. 统计页面流动走向

4.3. 统计前后台切换时机

#### Gradle Plugin开发的目标效果

根据以上的操作后，就能做。做到开发人员无感知，低业务耦合目标

![](https://github.com/dengluoy/PicassoUtils/blob/master/WechatIMG263.png?raw=true)


## 结语
途家目前已经实现了实现全面的Hook埋点机制。已经使用的对象有途家、蚂蚁短租、安伴智能三家公司使用。
